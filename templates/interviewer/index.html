{% extends "base.html" %}

{% block body %}
    <style>
        .refreshIcon {
            right: -12px;
            top: -51px;
        }

        #wrapper {
            width: 888px;
            margin: 0 auto;
            margin-top: 20px;
        }

        #app {
            margin: 30px;
        }

        .el-step__head.is-finish, .el-step__title.is-finish, .el-step__description.is-finish {
            color: #009688;
            border-color: #009688;
        }

        .avatar {
            width: 328px;
            height: 178px;
            display: block;
        }

        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }

        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 328px;
            height: 178px;
            line-height: 178px;
            text-align: center;
        }

        .step1 .el-divider__text.is-center {
            width: 333px;
        }

        .next2 {
            height: 100px;
            margin: 30px;
        {#margin-left: 100px;#}
        }

        .next4 {
            height: 100px;
            margin: 30px;
        {#margin-left: 100px;#}
        }

        .box-card {
            margin-bottom: 20px;
        }

        .step4 img {
            width: 200px;
            height: auto;
        }

    </style>
    <div class="container">
        <div class="container-fluid">
            <div class="form-row">
                <div class="col-12">
                    <div class="slidercaptcha card">
                        <div class="card-header">
                            <span>请完成安全验证!</span>
                        </div>
                        <div class="card-body">
                            <div id="captcha"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="app">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend><span v-text="role_name"></span></legend>
        </fieldset>
        <el-steps :active="active">
            <el-step title="步骤 1" description="身份信息"></el-step>
            <el-step title="步骤 2" description="学历信息"></el-step>
            <el-step title="步骤 3" description="工作经历"></el-step>
            <el-step title="步骤 4" description="其他证明"></el-step>
            <el-step title="步骤 5" description="拥有技能"></el-step>
            <el-step title="步骤 6" description="提交"></el-step>
            <el-step title="步骤 7" description="审核"></el-step>
        </el-steps>
        <div id="wrapper"
             v-loading="loading_post"
             element-loading-text="拼命处理中"
             element-loading-spinner="el-icon-loading"
        >
            <!-- 第一步 -->
            <transition name="el-fade-in-linear" v-if="active === 0">
                <div class="step1">
                    <el-card class="box-card">
                        <div slot="header" class="clearfix">
                            <span>身份信息</span>
                        </div>
                        <el-form ref="form" :model="form" label-width="100px" :rules="rules1">

                            <el-form-item label="手机号:" prop="phone" v-if="!token">
                                <el-input v-model.number="form.phone" maxlength="11" id="phone" type="number"
                                          oninput="if(value.length > 11)value = value.slice(0, 11)"></el-input>
                                <el-button @click="code_layer()" style="margin-top: 10px;" id="send_code"
                                           :disabled="disabled" size="small" v-if="!token">
                                    获取验证码 <span class="code_time"></span></el-button>
                            </el-form-item>
                            <el-form-item label="手机号:" prop="phone" v-if="token">
                                <el-input v-model.number="form.phone" maxlength="11" id="phone" type="number"
                                          oninput="if(value.length > 11)value = value.slice(0, 11)"
                                          disabled="disabled"></el-input>
                            </el-form-item>
                            <el-form-item label="验证码:" prop="code" v-if="!token">
                                <el-input v-model.number="form.code" maxlength="6"
                                          oninput="if(value.length > 11)value = value.slice(0, 6)"></el-input>
                            </el-form-item>
                            <el-form-item label="密码:" prop="password1" v-if="!token">
                                <el-input v-model="form.password1" maxlength="12" type="password"></el-input>
                            </el-form-item>
                            <el-form-item label="确认密码:" prop="password2" v-if="!token">
                                <el-input v-model="form.password2" maxlength="12" type="password"></el-input>
                            </el-form-item>
                            <el-form-item label="身份证(正面):" prop="imageUrl1">
                                <el-upload
                                        v-loading="loading"
                                        element-loading-text="拼命识别中"
                                        element-loading-spinner="el-icon-loading"
                                        class="avatar-uploader"
                                        :action="upload_url"
                                        :show-file-list="false"
                                        :on-success="handleAvatarSuccess"
                                        :before-upload="beforeAvatarUpload">
                                    <img v-if="imageUrl1" :src="imageUrl1" class="avatar">
                                    <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                </el-upload>
                            </el-form-item>

                            <el-form-item label="身份证(反面):" prop="imageUrl2">
                                <el-upload
                                        v-loading="loading2"
                                        element-loading-text="拼命识别中"
                                        element-loading-spinner="el-icon-loading"
                                        class="avatar-uploader"
                                        :action="upload_url"
                                        :show-file-list="false"
                                        :on-success="handleAvatarSuccess2"
                                        :before-upload="beforeAvatarUpload">
                                    <img v-if="imageUrl2" :src="imageUrl2" class="avatar">
                                    <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                </el-upload>
                            </el-form-item>
                            <div v-if="imageUrl1">
                                <el-form ref="ocr_info" :model="form.ocr_info_front" label-width="100px"
                                         :rules="rulesocr1">
                                    <el-form-item label="">
                                        <el-divider>请核对您的身份信息，如有错误请点击图片重新上传</el-divider>
                                    </el-form-item>
                                    <el-form-item label="姓名:" prop="username">
                                        <el-input v-model="form.ocr_info_front.name" maxlength="5"></el-input>
                                    </el-form-item>
                                    <el-form-item label="身份号码:" prop="number_id">
                                        <el-input v-model="form.ocr_info_front.number_id" maxlength="18"></el-input>
                                    </el-form-item>
                                </el-form>


                            </div>
                            <div v-if="imageUrl2">

                                <el-form-item label="有效期:" prop="back_time">
                                    <el-date-picker
                                            v-model="form.ocr_info_back.time"
                                            type="daterange"
                                            range-separator="至"
                                            start-placeholder="开始日期"
                                            end-placeholder="结束日期">
                                    </el-date-picker>
                                </el-form-item>
                            </div>
                            <el-form-item>

                            </el-form-item>
                        </el-form>
                    </el-card>
                    <div class="next2">
                        <el-button type="primary" size="small" @click="next(-1)" v-if="active > 1 && active <= 5">上一步
                        </el-button>
                        <el-button type="primary" size="small" @click="next(1, 'form', 'ocr_info')" v-if="active < 5"
                                   style="float: right">下一步
                        </el-button>
                    </div>

                </div>
            </transition>

            <!-- 第二步 -->
            <transition name="el-fade-in-linear" v-if="active === 1">
                <div>
                    <div v-for="(item,i) in school_list" :key="i" class="text item">
                        <el-card class="box-card">
                            <div slot="header" class="clearfix">
                                <span>学历信息</span>
                            </div>

                            <el-form ref="school_ref" :model="item" label-width="100px" :rules="school_ref">
                                <el-divider>学历</el-divider>
                                <el-form-item label="学历:" prop="education">
                                    <el-input v-model="item.education" maxlength="10"></el-input>
                                </el-form-item>
                                <el-form-item label="学校:" prop="school">
                                    <el-input v-model="item.school" maxlength="10"></el-input>
                                </el-form-item>
                                <el-form-item label="专业:" prop="speciality">
                                    <el-input v-model="item.speciality" maxlength="10"></el-input>
                                </el-form-item>
                                <el-form-item label="上学时间" prop="time">
                                    <el-date-picker
                                            v-model="item.time"
                                            type="daterange"
                                            range-separator="至"
                                            start-placeholder="入学日期"
                                            end-placeholder="毕业日期"
                                    >
                                    </el-date-picker>

                                </el-form-item>
                                <el-form-item label="毕业证:" prop="diploma">
                                    <el-upload
                                            element-loading-text="上传中"
                                            element-loading-spinner="el-icon-loading"
                                            class="avatar-uploader"
                                            :action="upload_url"
                                            :show-file-list="false"
                                            :on-success="(response) =>handleAvatarSuccess3(response, i, 1)"
                                            :before-upload="beforeAvatarUpload">
                                        <img v-if="item.diploma" :src="item.diploma" class="avatar">
                                        <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                    </el-upload>
                                </el-form-item>
                                <el-form-item label="学位证:" prop="degree">
                                    <el-upload
                                            element-loading-text="上传中"
                                            element-loading-spinner="el-icon-loading"
                                            class="avatar-uploader"
                                            :action="upload_url"
                                            :show-file-list="false"
                                            :on-success="(response) =>handleAvatarSuccess3(response, i, 2)"
                                            :before-upload="beforeAvatarUpload">
                                        <img v-if="item.degree" :src="item.degree" class="avatar">
                                        <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                    </el-upload>

                                </el-form-item>
                                <el-form-item label="">
                                    <el-button style="float: left;" type="primary" size="small"
                                               v-if="i===school_list.length-1"
                                               @click="add_school_det()" icon="el-icon-plus" circle>
                                    </el-button>
                                    <el-button style="float: left;" type="danger" size="small" v-if="i!=0"
                                               @click="del_school_det(i)" icon="el-icon-minus" circle>
                                    </el-button>
                                </el-form-item>

                            </el-form>

                        </el-card>
                    </div>
                    <div class="next2">
                        <el-button type="primary" size="small" @click="next(-1)">上一步</el-button>
                        <el-button type="primary" size="small" @click="next(1, 'school_ref')" style="float: right">下一步
                        </el-button>
                    </div>
                </div>
            </transition>
            <!-- 第三步 -->
            <transition name="el-fade-in-linear" v-if="active === 2">
                <div>
                    <div v-for="(item,i) in work_list" :key="i" class="text item">
                        <el-card class="box-card">
                            <div slot="header" class="clearfix">
                                <span>工作经历</span>
                                <a href="javascript:" style="float: right; color: red;" v-if="i!=0"
                                   @click="del_work_det(i)">删除
                                </a>
                            </div>

                            <el-form ref="work_rules" :model="item" label-width="100px" :rules="work_rules">
                                <el-divider>工作经历</el-divider>
                                <el-form-item label="公司名:" prop="name">
                                    <el-input v-model="item.name" maxlength="10"></el-input>
                                </el-form-item>
                                <el-form-item label="从事行业:" prop="industry">
                                    <el-input v-model="item.industry" maxlength="10"></el-input>
                                </el-form-item>
                                <el-form-item label="岗位:" prop="post">
                                    <el-input v-model="item.post" maxlength="10"></el-input>
                                </el-form-item>

                                <el-form-item label="技能关键词:" prop="keyword">
                                    <el-input v-model="item.keyword" maxlength="100"></el-input>
                                </el-form-item>

                                <el-form-item label="工作时间:" prop="time">
                                    <el-date-picker
                                            v-model="item.time"
                                            type="daterange"
                                            range-separator="至"
                                            start-placeholder="入职时间"
                                            end-placeholder="离职时间">
                                    </el-date-picker>

                                </el-form-item>
                                <el-form-item label="" prop="back_time">
                                    <el-button style="float: left;" type="primary" size="small"
                                               v-if="i===work_list.length-1"
                                               @click="add_work_det()" icon="el-icon-plus" circle>
                                    </el-button>

                                </el-form-item>
                            </el-form>
                        </el-card>
                    </div>
                    <div class="next2">
                        <el-button type="primary" @click="next(-1)" size="small">上一步</el-button>
                        <el-button type="primary" @click="next(1, 'work_rules')" size="small" style="float: right">下一步
                        </el-button>
                    </div>
                </div>
            </transition>
            <!-- 第四步 -->
            <transition name="el-fade-in-linear" v-if="active === 3">
                <div>
                    <div class="text item">
                        <el-card class="box-card">
                            <div slot="header" class="clearfix">
                                <span>其他证明</span>
                            </div>

                            <el-form ref="prove_rules" :model="prove" label-width="100px" :rules="prove_rules">
                                <el-divider>其他证明材料</el-divider>
                                <el-form-item label="在职证明:" prop="work">
                                    <el-upload
                                            element-loading-text="上传中"
                                            element-loading-spinner="el-icon-loading"
                                            class="avatar-uploader"
                                            :action="upload_url"
                                            :show-file-list="false"
                                            :on-success="(response) =>handleAvatarSuccess3(response, 0, 3)"
                                            :before-upload="beforeAvatarUpload">
                                        <img v-if="prove.work" :src="prove.work" class="avatar">
                                        <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                    </el-upload>
                                </el-form-item>
                                <el-form-item label="社保证明:" prop="security">
                                    <el-upload
                                            element-loading-text="上传中"
                                            element-loading-spinner="el-icon-loading"
                                            class="avatar-uploader"
                                            :action="upload_url"
                                            :show-file-list="false"
                                            :on-success="(response) =>handleAvatarSuccess3(response, 0, 4)"
                                            :before-upload="beforeAvatarUpload">
                                        <img v-if="prove.security" :src="prove.security" class="avatar">
                                        <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                    </el-upload>
                                </el-form-item>
                                <el-form-item label="其他证明:">
                                    <el-upload
                                            element-loading-text="上传中"
                                            element-loading-spinner="el-icon-loading"
                                            class="avatar-uploader"
                                            :action="upload_url"
                                            :show-file-list="false"
                                            :on-success="(response) =>handleAvatarSuccess3(response, 0, 5)"
                                            :before-upload="beforeAvatarUpload">
                                        <img v-if="prove.other" :src="prove.other" class="avatar">
                                        <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                    </el-upload>
                                </el-form-item>

                            </el-form>
                        </el-card>
                    </div>
                    <div class="next2">
                        <el-button type="primary" @click="next(-1)" size="small">上一步</el-button>
                        <el-button type="primary" @click="next(1, 'prove_rules')" style="float: right" size="small">
                            下一步
                        </el-button>

                    </div>
                </div>
            </transition>
            <!-- 第五步 -->
            <transition name="el-fade-in-linear" v-if="active === 4">
                <div>
                    <div v-for="(item,i) in knowledge_list" :key="i" class="text item">
                        <el-card class="box-card">
                            <div slot="header" class="clearfix">
                                <span>专业技能</span>
                                <a href="javascript:" style="float: right; color: red;" v-if="i!=0"
                                   @click="del_knowledge_det(i)">删除
                                </a>
                            </div>
                            <el-form ref="knowledge_rules" :model="item" label-width="120px" :rules="knowledge_rules">
                                <el-divider>专业技能</el-divider>
                                <el-form-item label="技能类型:">
                                    <template>
                                        <el-radio v-model="item.type" label="1">平台技能</el-radio>
                                        <el-radio v-model="item.type" label="2">其他技能</el-radio>
                                    </template>
                                </el-form-item>
                                <el-form-item label="技能名称:" prop="name" v-if="item.type == 1">
                                    <template>
                                        <el-select v-model="item.name" placeholder="请选择">
                                            <el-option
                                                    v-for="item in subjects"
                                                    :key="item.id"
                                                    :label="item.name"
                                                    :value="item.name">
                                            </el-option>
                                        </el-select>
                                    </template>
                                </el-form-item>
                                <el-form-item label="技能名称:" prop="name" v-if="item.type == 2">
                                    <el-input v-model="item.name" maxlength="10"></el-input>
                                </el-form-item>
                                <el-form-item label="使用时长(月):" prop="use_month">
                                    <el-input v-model.number="item.use_month" maxlength="10"></el-input>
                                </el-form-item>
                                <el-form-item label="掌握程度:" prop="level">
                                    <template>
                                        <el-radio v-model="item.level" label="1">一般</el-radio>
                                        <el-radio v-model="item.level" label="2">熟练</el-radio>
                                        <el-radio v-model="item.level" label="3">良好</el-radio>
                                        <el-radio v-model="item.level" label="4">精通</el-radio>
                                    </template>
                                </el-form-item>
                                <el-form-item label="" prop="back_time">
                                    <el-button style="float: left;" type="primary" size="small"
                                               v-if="i===knowledge_list.length-1"
                                               @click="add_knowledge_det()" icon="el-icon-plus" circle>
                                    </el-button>

                                </el-form-item>
                            </el-form>
                        </el-card>
                    </div>
                    <div class="next2">
                        <el-button type="primary" @click="next(-1)" size="small">上一步</el-button>
                        <el-button type="primary" @click="next(1, 'knowledge_rules')" size="small" style="float: right">下一步
                        </el-button>
                    </div>
                </div>
            </transition>
            <!-- 第6步 -->
            <transition name="el-fade-in-linear" v-if="active === 5">
                <div class="step4">
                    <el-descriptions class="margin-top" title="" :column="3" border>

                        <el-descriptions-item>
                            <template slot="label">
                                <i class="el-icon-user"></i>
                                姓名
                            </template>
                            <p v-text="form.ocr_info_front.name"></p>

                        </el-descriptions-item>
                        <el-descriptions-item>
                            <template slot="label">
                                <i class="el-icon-mobile-phone"></i>
                                手机号
                            </template>
                            <p v-text="form.phone"></p>
                        </el-descriptions-item>
                        <el-descriptions-item>
                            <template slot="label">
                                <i class="el-icon-tickets"></i>
                                身份证号
                            </template>
                            <p v-text="form.ocr_info_front.number_id"></p>
                        </el-descriptions-item>
                        <el-descriptions-item span="2">
                            <template slot="label">
                                <i class="el-icon-office-building"></i>
                                联系地址
                            </template>
                            <p v-text="form.ocr_info_front.address"></p>
                        </el-descriptions-item>

                        <el-descriptions-item span="3">
                            <template slot="label">
                                <i class="el-icon-office-building"></i>
                                身份证有效期
                            </template>
                            <span v-text="form.ocr_info_back.start_time"></span> -- <span
                                v-text="form.ocr_info_back.end_time"></span>
                        </el-descriptions-item>
                        <template v-for="(item,i) in school_list">
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    学校
                                </template>
                                <p v-text="item.school"></p>

                            </el-descriptions-item>
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    学历
                                </template>
                                <p v-text="item.education"></p>
                            </el-descriptions-item>
                            <el-descriptions-item span="2" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    专业
                                </template>
                                <p v-text="item.speciality"></p>
                            </el-descriptions-item>
                            <el-descriptions-item span="3" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    入学毕业时间
                                </template>
                                <span v-text="handle_time(item.time)"></span>
                            </el-descriptions-item>
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    毕业证
                                </template>
                                <img v-if="item.diploma" :src="item.diploma" class="avatar">
                            </el-descriptions-item>
                            <el-descriptions-item span="2" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    学位证
                                </template>
                                <img v-if="item.degree" :src="item.degree" class="avatar">
                            </el-descriptions-item>
                        </template>
                        <template v-for="(item,i) in work_list">
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    公司名
                                </template>
                                <p v-text="item.name"></p>
                            </el-descriptions-item>
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    从事行业
                                </template>
                                <p v-text="item.industry"></p>
                            </el-descriptions-item>
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    岗位
                                </template>
                                <p v-text="item.post"></p>
                            </el-descriptions-item>
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    技能关键词
                                </template>
                                <span v-text="item.keyword"></span>
                            </el-descriptions-item>
                            <el-descriptions-item span="2" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    工作时间
                                </template>
                                <span v-text="handle_time(item.time)"></span>
                            </el-descriptions-item>
                        </template>
                        <el-descriptions-item span="3">
                            <template slot="label">
                                <i class="el-icon-office-building"></i>
                                公司在职证明
                            </template>
                            <img v-if="prove.work" :src="prove.work" class="avatar">
                        </el-descriptions-item>
                        <el-descriptions-item span="3">
                            <template slot="label">
                                <i class="el-icon-office-building"></i>
                                社保证明
                            </template>
                            <img v-if="prove.security" :src="prove.security" class="avatar">
                        </el-descriptions-item>
                        <el-descriptions-item span="3">
                            <template slot="label">
                                <i class="el-icon-office-building"></i>
                                其他证明
                            </template>
                            <img v-if="prove.other" :src="prove.other" class="avatar">
                        </el-descriptions-item>

                        <template v-for="(item,i) in knowledge_list">
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>技能名称
                                </template>
                                <p v-text="item.name"></p>
                            </el-descriptions-item>
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    使用时长
                                </template>
                                <p v-text="item.use_month"></p>
                            </el-descriptions-item>
                            <el-descriptions-item span="1" :key="i">
                                <template slot="label">
                                    <i class="el-icon-office-building"></i>
                                    掌握程度
                                </template>
                                <p v-text="item.level"></p>
                            </el-descriptions-item>

                        </template>
                    </el-descriptions>
                    <div class="next4">
                        <el-button type="primary" @click="next(-1)" size="small">上一步</el-button>
                        <el-button type="primary" @click="next(1, 'form')" size="small" style="float: right;">提交审核
                        </el-button>

                    </div>
                </div>
            </transition>
            <!-- 第7步 -->
            <transition name="el-fade-in-linear" v-if="active === 6">
                <div class="step5">
                    <el-result title="提交审核成功, 扫码关注“云数智学”公众号及时获取审核信息！" subTitle="请根据提示进行操作">
                        <template slot="icon">
                            <el-image src="/media/img/gzh.jpg" style="width: 170px;"></el-image>
                        </template>
                        <template slot="extra">
                            <a href="javascript:window.parent.location.href = `/`">
                                <el-button type="primary">返回首页</el-button>
                            </a>
                        </template>
                    </el-result>
                </div>
            </transition>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script>

        var number_id_img1 = "";
        var number_id_img2 = "";
        var password1 = ''
        var checkPassword1 = (rule, value, callback) => {
            password1 = value
            if (!value) {
                return callback(new Error('密码不能为空'));
            }
            if (value.length < 6 || value.length > 12) {
                return callback(new Error('密码长度在 6 到 12 个字符'));
            }
            callback();
        };
        var checkPassword2 = (rule, value, callback) => {
            if (!value) {
                return callback(new Error('确认密码不能为空'));
            }
            if (value !== password1) {
                return callback(new Error('两次输入密码不一致'));
            }
            callback();
        };
        var vue = new Vue({
            el: "#app",
            data: {
                role_id: 2,
                role_name: '11',
                // 其他证明验证
                prove_rules: {
                    work: [
                        {required: true, message: '请上传在职证明', trigger: 'blur'},
                    ],
                    security: [
                        {required: true, message: '请上传社保证明', trigger: 'blur'},
                    ],

                },
                // 其他证明
                prove: {
                    work: '',
                    security: "",
                    other: ""
                },
                school_ref: {
                    education: [
                        {required: true, message: '请填写学历', trigger: 'blur'},
                    ],
                    school: [
                        {required: true, message: '请填写毕业学校', trigger: 'blur'},
                    ],
                    speciality: [
                        {required: true, message: '请填写专业', trigger: 'blur'},
                    ],
                    diploma: [
                        {required: true, message: '请上传毕业证', trigger: 'blur'},
                    ],
                    degree: [
                        {required: true, message: '请上传学位证', trigger: 'blur'},
                    ],
                    time: [
                        {required: true, message: '请填写上学时间', trigger: 'blur'},
                    ]
                },
                // 学历信息
                school_list: [
                    {
                        education: "",
                        school: "",
                        speciality: "",
                        time: [],
                        diploma: "",
                        degree: "",
                    }
                ],
                // 工作信息验证
                work_rules: {
                    name: [
                        {required: true, message: '请填写公司名称', trigger: 'blur'},
                    ],
                    industry: [
                        {required: true, message: '请填写从事行业', trigger: 'blur'},
                    ],
                    post: [
                        {required: true, message: '请填写岗位', trigger: 'blur'},
                    ],
                    time: [
                        {required: true, message: '请选择工作时间', trigger: 'blur'},
                    ],
                    keyword: [
                        {required: true, message: '请填写技能关键词', trigger: 'blur'},
                    ],
                },
                // 工作信息
                work_list: [
                    {
                        name: "",
                        industry: "",
                        post: "",
                        time: ['', ''],
                        start_time: "",
                        end_time: "",
                        keyword: "",
                    }
                ],
                // 技能信息
                knowledge_list: [
                    {
                        use_month: "",
                        level: "",
                        type: "1",  // 1固定 2其他
                        name: "",
                    }
                ],
                // 技能信息验证
                knowledge_rules: {
                    name: [
                        {required: true, message: '请选择或输入技能名称', trigger: 'blur'},
                    ],
                    use_month: [
                        {required: true, message: '请输入使用时长', trigger: 'blur'},
                    ],
                    level: [
                        {required: true, message: '请选择掌握程度', trigger: 'blur'},
                    ],
                },
                subjects: [],
                disabled: false,
                loading_post: false,
                loading: false,
                loading2: false,
                active: {{ step_id|default:0 }},
                // active: 4,
                token: "",
                // 第一步的ocr信息验证
                rulesocr1: {
                    username: [
                        {required: true, message: '请填写姓名', trigger: 'blur'},
                        {min: 2, max: 10, message: '长度在 2 到 10 个字符', trigger: 'blur'}
                    ],
                    number_id: [
                        {required: true, message: '请填写身份证号码', trigger: 'blur'},
                        {min: 18, max: 18, message: '请输入18为公民身份证号', trigger: 'blur'}
                    ],
                    back_time: [
                        {required: true, message: '请填写身份证有效期', trigger: 'blur'},
                    ]
                },
                // 第一步基础信息验证
                rules1: {
                    password1: [
                        {validator: checkPassword1, trigger: 'blur'}
                    ],
                    password2: [
                        {validator: checkPassword2, trigger: 'blur'}
                    ],
                    code: [{required: true, message: '请填写验证码', trigger: 'blur'}],
                    phone: [
                        {required: true, message: '请填写手机号', trigger: 'blur'},
                    ]

                },
                form: {
                    password1: '',
                    password2: '',
                    code: '',
                    phone: '',
                    ocr_info_front: {
                        name: '',
                        number_id: '',
                        address: '',

                    },
                    ocr_info_back: {
                        start_time: '',
                        end_time: '',
                        time: []
                    }
                },
                ocr_front: {},
                ocr_back: {},
                imageUrl1: '',
                imageUrl2: '',
                upload_url: "{{ upload_url|safe }}",
                web_file_url: "{{ web_file_url|safe }}",
                exit_count: 60,

            },
            created() {

                this.subjects = {{ subjects|safe }}
                this.token = localStorage.getItem("Token")
                this.role_id = "{{ role_id }}"
                if (this.role_id == 3) {
                    this.role_name = '面试专家'
                } else if (this.role_id == 2) {
                    this.role_name = '出题专家'
                } else {
                    this.role_name = '出题专家 + 面试专家'
                }
                if (this.active !== 5) {
                    var thsi = this;
                    this.loading_post = true;
                    $.get("/interviewer/save/?role_id=" + thsi.role_id, function (res) {
                        thsi.loading_post = false;
                        if (res.response === 'ok') {
                            var data = res.data;
                            if (data.form) {
                                // 第一步
                                thsi.form.phone = data.form.phone;
                                thsi.imageUrl1 = data.form.imageUrl1
                                thsi.active = data.step_id
                                thsi.imageUrl2 = data.form.imageUrl2
                                if (data.form.phone) {
                                    $("#phone").attr('disabled', '')
                                }
                                if (data.form.ocr_front) {
                                    thsi.form.ocr_info_front.name = data.form.name
                                    thsi.form.ocr_info_front.address = data.form.ocr_front.address || ''
                                    thsi.form.ocr_info_front.number_id = data.form.number_id
                                    thsi.form.ocr_info_back.start_time = data.form.start_time
                                    thsi.form.ocr_info_back.end_time = data.form.end_time
                                    thsi.form.ocr_info_back.time = [
                                        new Date(data.form.start_time.substring(0, 4),
                                            parseInt(data.form.start_time.substring(4, 6)) - 1,
                                            data.form.start_time.substring(6, 8)),
                                        new Date(data.form.end_time.substring(0, 4),
                                            parseInt(data.form.end_time.substring(4, 6)) - 1,
                                            data.form.end_time.substring(6, 8))]
                                    thsi.ocr_front = data.form.ocr_front
                                    thsi.ocr_back = data.form.ocr_back
                                }
                                if (data.school_list.length) {
                                    $.each(data.school_list, function (i) {
                                        this.time = [
                                            new Date(this.time[0].substring(0, 4),
                                                parseInt(this.time[0].substring(4, 6)) - 1,
                                                this.time[0].substring(6, 8)),
                                            new Date(this.time[1].substring(0, 4),
                                                parseInt(this.time[1].substring(4, 6)) - 1,
                                                this.time[1].substring(6, 8))
                                        ]
                                    })
                                    thsi.school_list = data.school_list
                                }

                                if (data.work_list.length) {
                                    $.each(data.work_list, function (i) {
                                        this.time = [
                                            new Date(this.time[0].substring(0, 4),
                                                parseInt(this.time[0].substring(4, 6)) - 1,
                                                this.time[0].substring(6, 8)),
                                            new Date(this.time[1].substring(0, 4),
                                                parseInt(this.time[1].substring(4, 6)) - 1,
                                                this.time[1].substring(6, 8))
                                        ]
                                    })
                                    thsi.work_list = data.work_list
                                }
                                if (data.knowledge_list.length){
                                    thsi.knowledge_list = data.knowledge_list
                                }
                                thsi.prove = data.prove || thsi.prove
                            }
                        } else {
                            msg_fail(res.message)
                        }

                    })
                }

            },
            methods: {

                // 处理时间
                handle_time(time) {
                    if (time.length) {
                        var start_time_year = time[0].getFullYear();
                        var start_time_moth = time[0].getMonth() + 1;
                        var start_time_day = time[0].getDate();
                        if (start_time_moth < 10) {
                            start_time_moth = '0' + start_time_moth
                        }
                        if (start_time_day < 10) {
                            start_time_day = '0' + start_time_day
                        }
                        var end_time_year = time[1].getFullYear();
                        var end_time_moth = time[1].getMonth() + 1;
                        var end_time_day = time[1].getDate();
                        if (end_time_moth < 10) {
                            end_time_moth = '0' + end_time_moth
                        }
                        if (end_time_day < 10) {
                            end_time_day = '0' + end_time_day
                        }
                        var start_time = `${start_time_year}${start_time_moth}${start_time_day}`
                        var end_time = `${end_time_year}${end_time_moth}${end_time_day}`
                        return `${start_time} -- ${end_time}`
                    }
                },
                code_layer() {
                    var thsi = this;
                    if (this.exit_count === 60) {
                        if (!this.form.phone) {
                            msg_fail('请输入手机号！')
                            return
                        }

                        layer.open({
                            type: 1,
                            shade: 0,
                            skin: 'alert-skin',
                            area: ['314px', '286px'],
                            content: $(".container").html(),
                            title: '',
                            success: function (obj, index) {
                                obj.css({'box-shadow': '', 'height': '', 'width': ''})
                                obj.find('.layui-layer-setwin').css({'display': 'none'})
                                var captcha = sliderCaptcha({
                                    id: obj.find('#captcha')[0],
                                    width: 280,
                                    height: 150,
                                    sliderL: 42,
                                    sliderR: 9,
                                    offset: 5,
                                    loadingText: '正在加载中...',
                                    failedText: '再试一次',
                                    barText: '向右滑动填充拼图',
                                    localImages: function () {
                                        return 'http://127.0.0.1:8087/upload/picture2.jpg';
                                    },
                                    setSrc: function () {
                                        return 'http://127.0.0.1:8087/upload/picture2.jpg';
                                        // return 'http://imgs.blazor.zone/images/Pic' + Math.round(Math.random() * 136) + '.jpg';
                                    },
                                    onSuccess: function () {
                                        var handler = setTimeout(function () {
                                            window.clearTimeout(handler);
                                            captcha.reset();
                                        }, 500);
                                        layer.close(index)
                                        thsi.send_code()
                                    },
                                    onFail: function () {
                                        console.log('验证失败')
                                    },
                                    onRefresh: function () {

                                    }
                                });
                            }
                        });
                    }
                },
                // 发送短信
                send_code() {
                    if (this.exit_count === 60) {
                        if (!this.form.phone) {
                            msg_fail('请输入手机号！')
                            return
                        }
                        var thsi = this;

                        $.post('/sms/send/', {phone: this.form.phone, code_id: 1}, function (res) {
                            if (res.response === 'ok') {
                                var inter_exit = window.setInterval(function () {
                                    thsi.exit_count--;
                                    if (thsi.exit_count <= 0) {
                                        thsi.exit_count = 60;
                                        thsi.disabled = false;
                                        window.clearInterval(inter_exit);
                                        $("#send_code .code_time").text('')
                                    } else {
                                        thsi.disabled = true;
                                        $("#send_code .code_time").text(thsi.exit_count + 's')
                                    }
                                }, 1000);
                                msg_ok("验证码已发送，2分钟内有效。")
                                msg_ok("验证码已发送，2分钟内有效。", function () {
                                })
                            } else {
                                msg_fail(res.message)
                            }
                        })


                    }
                },
                // 下一步
                next(num, formName) {
                    var thsi = this;
                    var is_val = true
                    if (num === 1) {
                        if (this.active !== 6) {
                            if (this.active === 0) {
                                this.$refs[formName].validate((valid) => {
                                    if (valid) {
                                        // 第一步
                                        thsi.save_step1()
                                    } else {
                                        return false;
                                    }
                                });
                            } else if (this.active === 1) {

                                $.each(this.$refs[formName], function (i) {
                                    this.validate((valid) => {
                                        if (valid) {
                                            is_val = true;
                                        } else {
                                            is_val = false;
                                        }
                                    });
                                })
                                if (is_val) {
                                    // 第二步
                                    this.save_step2()
                                }
                            } else if (this.active === 2) {
                                $.each(this.$refs[formName], function (i) {
                                    this.validate((valid) => {
                                        if (valid) {
                                            is_val = true;
                                        } else {
                                            is_val = false;
                                        }
                                    });
                                })
                                if (is_val) {
                                    // 第3步
                                    this.save_step3()
                                }
                            } else if (this.active === 3) {

                                this.$refs[formName].validate((valid) => {
                                    if (valid) {
                                        // 第4步
                                        this.save_step4()
                                    } else {
                                        return false;
                                    }
                                });
                            } else if (this.active === 4) {

                                $.each(this.$refs[formName], function (i) {
                                    this.validate((valid) => {
                                        if (valid) {
                                            is_val = true;
                                        } else {
                                            is_val = false;
                                        }
                                    });
                                })
                                if (is_val) {
                                    // 第3步
                                    this.save_step5()
                                }

                            } else if (this.active === 5) {
                                this.$confirm('确认提交审核?', '提示', {
                                    confirmButtonText: '确定',
                                    cancelButtonText: '取消',
                                    type: 'warning'
                                }).then(() => {
                                    $.post("/interviewer/save/?role_id=" + thsi.role_id, {
                                        token: this.token || localStorage.getItem("Token"),
                                        step_id: this.active + 1,
                                    }, function (res) {
                                        thsi.loading_post = false;
                                        if (res.response === 'ok') {
                                            thsi.active++
                                        } else {

                                            thsi.$message.error(res.message);
                                        }
                                    })
                                    this.$message({
                                        type: 'success',
                                        message: '提交成功!'
                                    });
                                }).catch(() => {
                                    this.$message({
                                        type: 'info',
                                        message: '已取消'
                                    });
                                });
                            }
                        }
                    } else {
                        // 上一步
                        thsi.active--
                    }
                },
                // 公共
                // 上传验证
                beforeAvatarUpload(file) {
                    const isJPG = file.type === 'image/jpeg' || file.type === 'image/png';
                    const isLt2M = file.size / 1024 / 1024 < 2;

                    if (!isJPG) {
                        this.$message.error('上传图片只能是 JPG 或 png 格式!');
                    }
                    if (!isLt2M) {
                        this.$message.error('上传图片大小不能超过 2MB!');
                    }
                    return isJPG && isLt2M;
                },
                // 处理时间
                handle_times(time) {
                    var start_time_year = time[0].getFullYear();
                    var start_time_moth = time[0].getMonth() + 1;
                    var start_time_day = time[0].getDate();
                    if (start_time_moth < 10) {
                        start_time_moth = '0' + start_time_moth
                    }
                    if (start_time_day < 10) {
                        start_time_day = '0' + start_time_day
                    }
                    var end_time_year = time[1].getFullYear();
                    var end_time_moth = time[1].getMonth() + 1;
                    var end_time_day = time[1].getDate();
                    if (end_time_moth < 10) {
                        end_time_moth = '0' + end_time_moth
                    }
                    if (end_time_day < 10) {
                        end_time_day = '0' + end_time_day
                    }
                    var start_time = `${start_time_year}${start_time_moth}${start_time_day}`
                    var end_time = `${end_time_year}${end_time_moth}${end_time_day}`
                    return [start_time, end_time]
                },
                // 第一步保存
                save_step1() {
                    var time = this.handle_times(this.form.ocr_info_back.time)
                    this.form.ocr_info_back.start_time = time[0]
                    this.form.ocr_info_back.end_time = time[1]
                    var post_data = {
                        token: this.token || localStorage.getItem("Token"),
                        step_id: this.active + 1,
                        password1: this.form.password1,
                        phone: this.form.phone,
                        code: this.form.code,
                        front: this.imageUrl1,
                        back: this.imageUrl2,
                        info_front: JSON.stringify(this.form.ocr_info_front),
                        info_back: JSON.stringify(this.form.ocr_info_back),
                        ocr_info_front: JSON.stringify(this.ocr_front),
                        ocr_info_back: JSON.stringify(this.ocr_back)
                    }
                    var thsi = this;
                    $.post("/interviewer/save/?role_id=" + thsi.role_id, post_data, function (res) {
                        thsi.loading_post = false;
                        if (res.response === 'ok') {
                            localStorage.setItem("Token", res.data.token);
                            thsi.token = res.data.token
                            thsi.active++
                            localStorage.setItem("userId", res.data.user_id);
                            localStorage.setItem("role", '用户');
                            localStorage.setItem("sessionTable", 'yonghu');
                            localStorage.setItem("adminName", this.form.phone);
                        } else {
                            thsi.$message.error(res.message);
                        }
                    })
                },

                // 第二步保存
                save_step2() {
                    var thsi = this;
                    $.each(this.school_list, function (i) {
                        var time = thsi.handle_times(this.time)
                        this.start_time = time[0]
                        this.end_time = time[1]
                    })
                    console.log(this.school_list)
                    var post_data = {
                        token: this.token || localStorage.getItem("Token"),
                        step_id: this.active + 1,
                        data: JSON.stringify(this.school_list)
                    }
                    $.post("/interviewer/save/?role_id=" + thsi.role_id, post_data, function (res) {
                        thsi.loading_post = false;
                        if (res.response === 'ok') {
                            thsi.active++
                        } else {

                            thsi.$message.error(res.message);
                        }
                    })

                },
                // 第三步
                save_step3() {
                    var thsi = this;
                    $.each(this.work_list, function (i) {
                        var time = thsi.handle_times(this.time)
                        this.start_time = time[0]
                        this.end_time = time[1]
                    })
                    var post_data = {
                        token: this.token || localStorage.getItem("Token"),
                        step_id: this.active + 1,
                        data: JSON.stringify(this.work_list)
                    }
                    $.post("/interviewer/save/?role_id=" + thsi.role_id, post_data, function (res) {
                        thsi.loading_post = false;
                        if (res.response === 'ok') {
                            thsi.active++
                        } else {

                            thsi.$message.error(res.message);
                        }
                    })

                },
                // save_step5
                save_step5() {
                    var thsi = this;

                    var post_data = {
                        token: this.token || localStorage.getItem("Token"),
                        step_id: this.active + 1,
                        data: JSON.stringify(this.knowledge_list)
                    }
                    $.post("/interviewer/save/?role_id=" + thsi.role_id, post_data, function (res) {
                        thsi.loading_post = false;
                        if (res.response === 'ok') {
                            thsi.active++
                        } else {
                            thsi.$message.error(res.message);
                        }
                    })

                },
                // 第4步
                save_step4() {
                    var thsi = this;
                    $.post("/interviewer/save/?role_id=" + thsi.role_id, {
                        token: this.token || localStorage.getItem("Token"),
                        step_id: this.active + 1, prove: JSON.stringify(this.prove)
                    }, function (res) {
                        thsi.loading_post = false;
                        if (res.response === 'ok') {
                            thsi.active++
                        } else {

                            thsi.$message.error(res.message);
                        }
                    })
                },
                // 第一步
                // 识别身份证正面
                handleAvatarSuccess(res) {
                    this.imageUrl1 = this.web_file_url + res.data[0].file_url
                    this.loading = true;
                    var thsi = this;
                    $.post('/interviewer/ocr_sfz/', {idCardSide: 'front', url: this.imageUrl1}, function (res) {
                        if (res.response === 'ok') {
                            thsi.loading = false;
                            thsi.form.ocr_info_front = res.data;
                            thsi.ocr_front = copy(res.data);
                        } else {
                            thsi.loading = false;
                            msg_fail(res.message)
                        }


                    })
                },
                // 识别身份证背面
                handleAvatarSuccess2(res) {
                    this.loading2 = true;
                    var thsi = this;
                    this.imageUrl2 = this.web_file_url + res.data[0].file_url
                    $.post('/interviewer/ocr_sfz/', {idCardSide: 'back', url: this.imageUrl2}, function (res) {
                        thsi.loading2 = false;
                        thsi.form.ocr_info_back = res.data;
                        thsi.form.ocr_info_back.time = [
                            new Date(res.data.start_time.substring(0, 4),
                                parseInt(res.data.start_time.substring(4, 6)) - 1,
                                res.data.start_time.substring(6, 8)),
                            new Date(res.data.end_time.substring(0, 4),
                                parseInt(res.data.end_time.substring(4, 6)) - 1,
                                res.data.end_time.substring(6, 8))]
                        thsi.ocr_back = copy(res.data);
                    })
                },


                // 第二步
                // 上传毕业证\学位证
                handleAvatarSuccess3(res, i, type) {
                    if (type === 1) {

                        this.school_list[i].diploma = this.web_file_url + res.data[0].file_url
                        console.log(i, this.school_list)
                    } else if (type === 2) {
                        this.school_list[i].degree = this.web_file_url + res.data[0].file_url
                    } else if (type === 3) {
                        this.prove.work = this.web_file_url + res.data[0].file_url
                    } else if (type === 4) {
                        this.prove.security = this.web_file_url + res.data[0].file_url
                    } else if (type === 5) {
                        this.prove.other = this.web_file_url + res.data[0].file_url
                    }
                    this.$forceUpdate();
                },

                // 新增学历信息
                add_school_det() {
                    if (this.school_list.length < 5) {
                        this.school_list.push({
                            education: "",
                            school: "",
                            speciality: "",
                            time: [],
                            diploma: "",
                            degree: "",
                        })
                    } else {
                        msg_fail("最多添加五个")
                    }

                },
                // 删除学历信息
                del_school_det(index) {
                    this.$confirm('确定删除此信息?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.school_list.splice(index, 1)
                        this.$message({
                            type: 'success',
                            message: '删除成功!'
                        });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                    });

                },

                // 删除工作经历
                del_work_det(index) {
                    this.$confirm('确定删除此信息?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.work_list.splice(index, 1)
                        this.$message({
                            type: 'success',
                            message: '删除成功!'
                        });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                    });

                },
                // 第三步
                // 新增工作经历
                add_work_det() {
                    if (this.work_list.length < 5) {
                        this.work_list.push({
                            name: "",
                            industry: "",
                            post: "",
                            time: [],
                            start_time: "",
                            end_time: "",
                            keyword: "",
                        })
                    } else {
                        msg_fail("最多添加5个")
                    }
                },
                // 新增技能
                add_knowledge_det() {
                    if (this.knowledge_list.length < 20) {
                        this.knowledge_list.push({
                            sid: "",
                            use_month: "",
                            level: "",
                            type: "1",
                            name: "",
                        })
                    } else {
                        msg_fail("最多添加20个技能")
                    }
                },
                // 删除技能
                del_knowledge_det(index) {
                    this.$confirm('确定删除此信息?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.knowledge_list.splice(index, 1)
                        this.$message({
                            type: 'success',
                            message: '删除成功!'
                        });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                    });

                },
            }
        })

        function navPage(url) {
            localStorage.setItem('iframeUrl', url);
            document.getElementById('iframe').src = url;
        }

    </script>
{% endblock %}
